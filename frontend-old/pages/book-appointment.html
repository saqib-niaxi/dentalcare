<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Appointment - Dr. Ahmed Dental Care</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container">
      <div class="logo">
        <h2>Dr. Ahmed Dental Care</h2>
      </div>
      <ul class="nav-links" id="navLinks">
        <li><a href="../index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="services.html">Services</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="book-appointment.html" class="btn-primary">Book Appointment</a></li>
        <li><a href="login.html" id="loginLink">Login</a></li>
      </ul>
    </div>
  </nav>

  <!-- Login Required Notice -->
  <div id="loginRequired" style="display: none;">
    <section class="page-header">
      <div class="container">
        <h1>Please Login to Book Appointment</h1>
        <p>You need to be logged in to book an appointment</p>
        <a href="login.html" class="btn-primary btn-large">Go to Login</a>
      </div>
    </section>
  </div>

  <!-- Booking Form (Hidden until login) -->
  <div id="bookingContent">
    <section class="page-header">
      <div class="container">
        <h1>Book Your Appointment</h1>
        <p>Schedule your visit with Dr. Ahmed</p>
      </div>
    </section>

    <section class="page-content">
      <div class="container">
        <form class="booking-form" id="appointmentForm">
          <div class="form-row">
            <div class="form-group">
              <label for="service">Select Service *</label>
              <select id="service" name="service" required>
                <option value="">Choose a service</option>
                <!-- Services will be loaded dynamically -->
              </select>
            </div>
            <div class="form-group">
              <label for="date">Preferred Date *</label>
              <input type="date" id="date" name="date" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="time">Preferred Time *</label>
              <select id="time" name="time" required>
                <option value="">Select time</option>
                <option value="9:00 AM">9:00 AM</option>
                <option value="10:00 AM">10:00 AM</option>
                <option value="11:00 AM">11:00 AM</option>
                <option value="12:00 PM">12:00 PM</option>
                <option value="2:00 PM">2:00 PM</option>
                <option value="3:00 PM">3:00 PM</option>
                <option value="4:00 PM">4:00 PM</option>
                <option value="5:00 PM">5:00 PM</option>
              </select>
            </div>
            <div class="form-group">
              <label for="notes">Additional Notes (Optional)</label>
              <textarea id="notes" name="notes" rows="4" placeholder="Tell us about your dental concerns..."></textarea>
            </div>
          </div>

          <button type="submit" class="btn-primary btn-large" style="width: 100%;">
            Book Appointment
          </button>
        </form>

        <div id="bookingMessage" style="margin-top: 2rem;"></div>
      </div>
    </section>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container">
      <p>&copy; 2024 Dr. Ahmed Dental Care. All rights reserved.</p>
    </div>
  </footer>

  <script src="../js/main.js"></script>
  <script>
    // Check login status on load
    document.addEventListener('DOMContentLoaded', async () => {
      await checkAuth();
      updateBookingPage();
    });

    async function updateBookingPage() {
      const token = localStorage.getItem('token');
      const loginRequired = document.getElementById('loginRequired');
      const bookingContent = document.getElementById('bookingContent');

      if (!token) {
        loginRequired.style.display = 'block';
        bookingContent.style.display = 'none';
        return;
      }

      // Verify token is valid
      try {
        const response = await fetch('/api/auth/profile', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          localStorage.removeItem('token');
          loginRequired.style.display = 'block';
          bookingContent.style.display = 'none';
          return;
        }

        const data = await response.json();
        if (data.user.role === 'admin') {
          window.location.href = 'admin-panel.html';
          return;
        }

        // Load services for logged-in patient
        await loadServices();
        bookingContent.style.display = 'block';
        loginRequired.style.display = 'none';
      } catch (error) {
        localStorage.removeItem('token');
        loginRequired.style.display = 'block';
        bookingContent.style.display = 'none';
      }
    }

    async function loadServices() {
      try {
        const response = await fetch('/api/services');
        if (response.ok) {
          const data = await response.json();
          const serviceSelect = document.getElementById('service');

          data.services.forEach(service => {
            const option = document.createElement('option');
            option.value = service._id;
            option.textContent = service.name;
            serviceSelect.appendChild(option);
          });

          // Pre-select service if passed in URL
          const urlParams = new URLSearchParams(window.location.search);
          const serviceId = urlParams.get('service');
          if (serviceId) {
            serviceSelect.value = serviceId;
          }
        }
      } catch (error) {
        console.error('Failed to load services:', error);
      }
    }

    // Set minimum date to today
    const dateInput = document.getElementById('date');
    const today = new Date().toISOString().split('T')[0];
    dateInput.setAttribute('min', today);

    // Handle form submission (only for logged-in users)
    document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = {
        service: document.getElementById('service').value,
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        notes: document.getElementById('notes').value
      };

      const token = localStorage.getItem('token');
      if (!token) {
        showAlert('Please login to book appointment', 'error');
        return;
      }

      try {
        const response = await fetch('/api/appointments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(formData)
        });

        const data = await response.json();
        const messageDiv = document.getElementById('bookingMessage');

        if (response.ok) {
          messageDiv.innerHTML = `<div class="alert alert-success">
            Appointment booked successfully! Redirecting to your appointments...
          </div>`;

          document.getElementById('appointmentForm').reset();

          // Redirect to My Appointments page after 2 seconds
          setTimeout(() => {
            window.location.href = 'my-appointments.html';
          }, 2000);
        } else {
          messageDiv.innerHTML = `<div class="alert alert-error">
            ${data.message || 'Failed to book appointment. Please try again.'}
          </div>`;
        }

        setTimeout(() => {
          messageDiv.innerHTML = '';
        }, 5000);
      } catch (error) {
        showAlert('Failed to book appointment. Please try again.', 'error');
      }
    });
  </script>
</body>
</html>
